<!DOCTYPE html>
<html><head></head><body>
<script>
  function check_oauth(){
                // Check if we're returning from OAuth (i.e., if there's a hash in the URL)
            if (window.location.hash) {
            const accessToken = getAccessTokenFromUrl();
            if (accessToken) {
              console.log("Token found. Sending to Broadcast creation");
              createYouTubeBroadcast(accessToken, 'Test Broadcast')
                .then(() => {
                  console.log('Broadcast Created');
                })
                .catch(error => {
                  console.error('Error in process:', error);
                });
            }
          } else {
                console.log("Need to do reauth")
            // If we're not returning from OAuth, we need to start the OAuth flow
            // This would typically be triggered by a user action, like clicking a "Login" button
            /*
            function startOAuthFlow() {
                const clientId = 'YOUR_CLIENT_ID';
                const redirectUri = encodeURIComponent('YOUR_REDIRECT_URI');
                const scope = encodeURIComponent('https://www.googleapis.com/auth/youtube');
                const authUrl = `https://accounts.google.com/o/oauth2/auth?client_id=${clientId}&redirect_uri=${redirectUri}&scope=${scope}&response_type=token`;
                
                window.location.href = authUrl;
  }*/
  
  // You would call startOAuthFlow() when the user wants to authenticate
                        }





}// end of check_oauth()


function getAccessTokenFromUrl() {
  const hash = window.location.hash.substring(1);
  const params = new URLSearchParams(hash);
  const accessToken = params.get('access_token');
  
  if (accessToken) {
    console.log('Access Token:', accessToken);
    return accessToken;
  } else {
    console.error('Access token not found in URL');
    return null;
  }
}

// Function to create a YouTube broadcast
function createYouTubeBroadcast(accessToken, broadcastTitle) {
  console.log("Entered Broadcast creation");
  const apiUrl = 'https://www.googleapis.com/youtube/v3/liveBroadcasts?part=snippet,status';
  console.log("Step2 completed");
  
  const broadcastData = {
    snippet: {
      title: broadcastTitle,
      scheduledStartTime: new Date(Date.now() + 5 * 60000).toISOString(), // Start 5 minutes from now
      description: 'A new broadcast created via the YouTube API'
    },
    status: {
      privacyStatus: 'unlisted'
    }
  };
  
  console.log("Step3 completed");
  
  try {
    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(broadcastData)  // Send broadcastData directly, without the resource wrapper
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(`HTTP error! status: ${response.status}, message: ${JSON.stringify(errorData)}`);
    }
    
    const data = await response.json();
    console.log('Broadcast created successfully:', data);
    return data;
  } catch (error) {
    console.error('Error creating broadcast:', error);
    throw error;
  }
}










  
 function createYouTubeLiveStream(accessToken, streamTitle) {
  const apiUrl = 'https://www.googleapis.com/youtube/v3/liveStreams';
  
  const streamData = {
    snippet: {
      title: streamTitle,
      description: 'A new live stream created via the YouTube API'
    },
    cdn: {
      frameRate: 'variable',
      ingestionType: 'rtmp',
      resolution: 'variable'
    },
    contentDetails: {
      isReusable: true
    }
  };

  try {
    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        part: 'snippet,cdn,contentDetails',
        resource: streamData
      })
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();
    console.log('Live stream created successfully:', data);
    return data;
  } catch (error) {
    console.error('Error creating live stream:', error);
    throw error;
  }
} // end of createYouTubeLiveStream function

// Function to bind the stream to the broadcast
 function bindBroadcastToStream(accessToken, broadcastId, streamId) {
  const apiUrl = `https://www.googleapis.com/youtube/v3/liveBroadcasts/bind`;
  
  try {
    const response = await fetch(`${apiUrl}?id=${broadcastId}&streamId=${streamId}&part=id`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Accept': 'application/json'
      }
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();
    console.log('Broadcast bound to stream successfully:', data);
    return data;
  } catch (error) {
    console.error('Error binding broadcast to stream:', error);
    throw error;
  }
} // end of bindBroadcastToStream function


// Main function to orchestrate the process
async function createYouTubeLiveBroadcast(accessToken, title) {
  try {
    const broadcast =  check_oauth();
    /*const broadcast = await createYouTubeBroadcast(accessToken, title);*/
    const stream =  createYouTubeLiveStream(accessToken, `${title} - Stream`);
     bindBroadcastToStream(accessToken, broadcast.id, stream.id);
    
    console.log('Broadcast created and bound to stream successfully');
    console.log('Broadcast ID:', broadcast.id);
    console.log('Stream ID:', stream.id);
    console.log('Ingestion URL:', stream.cdn.ingestionInfo.ingestionAddress);
    console.log('Stream Name:', stream.cdn.ingestionInfo.streamName);
  } catch (error) {
    console.error('Error in creating live broadcast:', error);
  }
} // end of createYouTubeLiveBroadcast()




</script>

<button onclick="check_oauth();">Create Live Stream</button>
</body></html>
